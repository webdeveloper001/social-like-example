!function(){"use strict";function e(e,n){var t=[{name:"queries",parent:"admin",url:"/queries",templateUrl:"app/admin/Partials/queries.html",controller:"queries as vm"},{name:"views",parent:"admin",url:"/views",templateUrl:"app/admin/Partials/views.html",controller:"views as vm"},{name:"flags",parent:"admin",url:"/flags",templateUrl:"app/admin/Partials/flags.html",controller:"flags as vm"},{name:"addRank",parent:"admin",url:"/addRank",templateUrl:"app/admin/Partials/addRank.html",controller:"addRank as vm"},{name:"dbMaint",parent:"admin",url:"/dbMaint",templateUrl:"app/admin/Partials/dbMaint.html",controller:"dbMaint as vm"},{name:"mergeAnswers",parent:"admin",url:"/mergeAnswers",templateUrl:"app/admin/Partials/mergeAnswers.html",controller:"mergeAnswers as vm"},{name:"dbQuery",parent:"admin",url:"/dbQuery",templateUrl:"app/admin/Partials/dbQuery.html",controller:"dbQuery as vm"},{name:"imagesmod",parent:"admin",url:"/imagemod",templateUrl:"app/admin/Partials/imagesmod.html",controller:"imagesmod as vm"},{name:"staticpagesconsole",parent:"admin",url:"/staticpagesconsole",templateUrl:"app/admin/Partials/staticpagesconsole.html",controller:"staticpagesconsole as vm"},{name:"answerimages",parent:"admin",url:"/answerimages",templateUrl:"app/admin/Partials/answerimages.html",controller:"answerimages as vm"},{name:"sitemap",parent:"admin",url:"/sitemap",templateUrl:"app/admin/Partials/sitemap.html",controller:"sitemap as vm"},{name:"locations",parent:"admin",url:"/locations",templateUrl:"app/admin/Partials/locations.html",controller:"locations as vm"},{name:"updateHeaders",parent:"admin",url:"/updateHeaders",templateUrl:"app/admin/Partials/updateHeaders.html",controller:"updateHeaders as vm"},{name:"foodRanks",parent:"admin",url:"/foodRanks",templateUrl:"app/admin/Partials/foodRanks.html",controller:"foodRanks as vm"},{name:"sibLocs",parent:"admin",url:"/sibLocs",templateUrl:"app/admin/Partials/sibLocs.html",controller:"sibLocs as vm"},{name:"payment",parent:"admin",url:"/payment",templateUrl:"app/admin/Partials/payment.html",controller:"payment as vm"},{name:"plan",parent:"admin",url:"/plan",templateUrl:"app/admin/Partials/plan.html",controller:"plan as vm"},{name:"bizadmin",parent:"admin",url:"/bizadmin",templateUrl:"app/admin/Partials/bizadmin.html",controller:"bizadmin as vm"},{name:"cleandb",parent:"admin",url:"/cleandb",templateUrl:"app/admin/Partials/cleandb.html",controller:"cleandb as vm",resolve:{load:["$ocLazyLoad",function(e){return e.load({rerun:!0,files:["scripts/vendor3.js"]})}]}},{name:"rodconsole",url:"/rodconsole",parent:"layout",templateUrl:"app/admin/Partials/rodconsole.html",controller:"rodconsole as vm"}];$(t).each(function(){e.state(this)})}angular.module("app").config(["$stateProvider","$urlRouterProvider",e])}(),function(){"use strict";function e(e,n,t){var a=this;a.title="views",a.content=n.content,function(){console.log("views page Loaded!")}()}angular.module("app").controller("views",e),e.$inject=["$location","$rootScope","$state"]}(),function(){"use strict";function e(e,n,t,a,s,o){function i(){if(!m){m=!0;var e="",t=[],a=[];f.res=[];for(var o=!0,i="",r="",l=0;l<n.cblocks.length;l++){i="",r="",o=!0,{},a=[];for(var d=0;d<n.headlines.length;d++)if(n.cblocks[l].type==n.headlines[d].type){"city"==n.cblocks[l].scope&&(e=n.headlines[d].filter+" isMP"),"rx"==n.cblocks[l].scope&&(e=n.headlines[d].filter),"nh"==n.cblocks[l].scope&&(e=n.headlines[d].filter+" "+n.cblocks[l].scopename),t=e.split(" ");break}for(var u="",g=0;g<n.content.length;g++){u=n.content[g].tags+" "+n.content[g].title,o=!0;for(var p=0;p<t.length;p++){var h=t[p].charAt(0).toUpperCase()+t[p].slice(1),w=t[p].charAt(0).toLowerCase()+t[p].slice(1);o=o&&(u.indexOf(t[p])>-1||u.indexOf(t[p].toUpperCase())>-1||u.indexOf(h)>-1||u.indexOf(w)>-1)}o&&a.push(n.content[g].id)}c(a);for(var v=0;v<a.length;v++)i=i+":"+a[v];r=i.substring(1),s.update(n.cblocks[l].id,["catstr"],[r])}}}function r(){for(var e=!1,t=[],a=0;a<n.content.length;a++)n.content[a].title.indexOf("in Hillcrest")>-1&&t.push(n.content[a]);for(var s=0;s<t.length;s++){for(var i="",r="",c=t[s].title.replace("Hillcrest","San Diego"),l=0;l<n.content.length;l++)if(c==n.content[l].title){if(null==n.content[l].catstr||void 0==n.content[l].catstr||0==n.content[l].catstr.length){var d=n.content[l].id;if(473!=d&&3125!=d&&6949!=d&&7424!=d&&7675!=d&&3124!=d&&3163!=d&&3202!=d){console.log("Found gen rank --- ",n.content[l].title," ",n.content[l].id);for(var u=n.content[l].title.replace("San Diego",""),g=0;g<n.content.length;g++)n.content[g].title.indexOf(u)>-1&&g!=l&&(i=i+":"+n.content[g].id);r=i.substring(1),console.log("final catstr ---",r),o.update(n.content[l].id,["isatomic","catstr"],[!1,r])}}break}i="",r="",c=t[s].title.replace("Hillcrest","Downtown");for(var l=0;l<n.content.length;l++)if(c==n.content[l].title){if(null==n.content[l].catstr||void 0==n.content[l].catstr||0==n.content[l].catstr.length){var d=n.content[l].id;if(473!=d&&3125!=d&&6949!=d&&7424!=d&&7675!=d&&3124!=d&&3163!=d&&3202!=d){console.log("Found gen rank --- ",n.content[l].title," ",n.content[l].id);for(var u=n.content[l].title.replace("Downtown",""),g=0;g<n.content.length;g++)if(n.content[g].title.indexOf(u)>-1&&g!=l){e=!1;for(var a=0;a<n.districts.length;a++)n.content[g].title.includes(n.districts[a])&&(e=!0);e&&(i=i+":"+n.content[g].id)}r=i.substring(1),console.log("final catstr ---",r),o.update(n.content[l].id,["isatomic","catstr"],[!1,r])}}break}}}function c(e){for(var n,t,a=e.length;0!==a;)t=Math.floor(Math.random()*a),a-=1,n=e[a],e[a]=e[t],e[t]=n;return e}function l(){if(!p){for(var e=["rankofweek","city","lifestyle","food","politics","services","social","beauty","sports","personalities","technology","dating","health"],n={},t=0;t<e.length;t++)n={},n.scope="city",n.ismp=!0,n.scopename="San Diego",n.catstr="0",n.type=e[t],s.addcblock(n);p=!0}}function d(){if(!w){for(var e=["rankofweeknh","neighborhood","lifestyle","food","services","social","beauty","health"],n={},t=0;t<h.length;t++)for(var a=0;a<e.length;a++)n={},n.scope="nh",n.ismp=!1,n.scopename=h[t],n.catstr="0",n.type=e[a],s.addcblock(n);w=!0}}function u(){if(!v){for(var e=["rxfeedback","rxsuggestion"],n={},t=0;t<e.length;t++)n={},n.scope="rx",n.scopename="RankX",n.ismp=!1,n.catstr="0",n.type=e[t],s.addcblock(n);v=!0}}function g(){for(var e=0;e<n.cblocks.length;e++)s.deleteRec(n.cblocks[e].id)}var f=this;f.title="updateHeaders",f.refresh=i,f.createCBlocksRecsCity=l,f.createCBlocksRecsNh=d,f.createCBlocksRecsRankX=u,f.deleteCBlocks=g,f.catStrings=r,f.isAdmin=n.isAdmin;var m=!1;!function(){console.log("updateHeaders page Loaded!")}();var p=!1,h=n.nhs,w=!1,v=!1}angular.module("app").controller("updateHeaders",e),e.$inject=["$location","$rootScope","$state","headline","cblock","table"]}(),function(){"use strict";function e(e,n,t,a,s){function o(){f.mode="ranks",f.rankopts=[];for(var n=0;n<e.content.length;n++)f.rankopts.push(e.content[n].title)}function i(){f.mode="answers",f.rankopts=[];for(var n=0;n<e.answers.length;n++)f.rankopts.push(e.answers[n].name)}function r(){var t="";if("ranks"==f.mode)for(var a=0;a<e.content.length;a++)e.content[a].title==f.query&&(t="rank"+e.content[a].id+".html");if("answers"==f.mode)for(var a=0;a<e.answers.length;a++)e.answers[a].name==f.query&&(t="answer"+e.answers[a].id+".html");var s={},o="";s.filename=t,n.getPageContent(s).then(function(e){o=e.data,o=o.replace(/>/g,">&&&"),f.pagecontent=o.split("&&&")})}function c(){if("ranks"==f.mode)for(var a=0;a<e.content.length;a++)e.content[a].title==f.query&&n.createPageRank(e.content[a]).then(function(){t.notificationSuccess("Success","File recreated successfully")});if("answers"==f.mode)for(var a=0;a<e.answers.length;a++)e.answers[a].name==f.query&&n.createPageRank(e.answers[a]).then(function(){t.notificationSuccess("Success","File recreated successfully")})}function l(){var n="";if("ranks"==f.mode)for(var s=0;s<e.content.length;s++)if(e.content[s].title==f.query){n="rank"+e.content[s].id+".html";var o=a+n;FB.api("https://graph.facebook.com/","post",{id:[o],scrape:!0},function(e){t.notificationSuccess("Success","File scrapped successfully - "+e)})}if("answers"==f.mode)for(var s=0;s<e.answers.length;s++)if(e.answers[s].name==f.query){n="answer"+e.answers[s].id+".html";var o=a+n;FB.api("https://graph.facebook.com/","post",{id:[o],scrape:!0},function(e){t.notificationSuccess("Success","File scrapped successfully - "+e)})}}function d(n){if("ranks"==f.mode)for(var t=0;t<e.content.length;t++)if(e.content[t].title==f.query){var s="rank"+e.content[t].id+".html",o=a+s;FB.ui({method:"feed",link:o,caption:"An example caption"},function(e){})}if("answers"==f.mode)for(var t=0;t<e.answers.length;t++)if(e.answers[t].name==f.query){var s="answer"+e.answers[t].id+".html",o=a+s;FB.ui({method:"feed",link:o,caption:"An example caption"},function(e){})}}function u(){f.inprogress=!0;"answers"==f.mode&&(f.cpct=p/e.answers.length*100,"answer"+e.answers[p].id+".html",n.createPageAnswer(e.answers[p]),p++,s(function(){u()},400))}function g(){}var f=this;f.title="staticpagesconsole",f.dataready=!1,f.inprogress=!1;var m=[];f.rankopts=[];var p=0;f.selRanks=o,f.selAnswers=i,f.getPage=r,f.recreatePage=c,f.forceScrape=l,f.recreateAll=u,f.scrapeAll=g,f.share=d,f.pagecontent="",function(){o(),n.getFileList().then(function(e){m=e.data,f.dataready=!1,console.log("static pages list ready")}),e.DEBUG_MODE&&console.log("staticpagesconsole page Loaded!")}()}angular.module("app").controller("staticpagesconsole",e),e.$inject=["$rootScope","staticpages","dialog","SERVER_URL","$timeout"]}(),function(){"use strict";function e(e,n,t,a,s){function o(){r="",e.content.forEach(function(e){2==e.scope&&1==e.ismp&&null!=e.slug&&(r+="<url><loc>https://rank-x.com/rankSummary/"+e.slug+"</loc></url>")}),r=r.replace(/\/url>/g,"/url>&&&"),i.sitemap=r.split("&&&")}var i=this;i.title="sitemap",i.createSitemap=o;var r="";i.sitemap="",function(){console.log("sitemap console loaded")}()}angular.module("app").controller("sitemap",e),e.$inject=["$rootScope","staticpages","dialog","SERVER_URL","$timeout"]}(),function(){"use strict";function e(e,n,t,a,s,o,i){function r(){console.log("query Answer"),m.ansOpts=[];for(var e=0;e<n.answers.length;e++)m.ansOpts.push(n.answers[e].name)}function c(){for(var e=0;e<n.answers.length;e++)m.answername==n.answers[e].name&&(m.answer=n.answers[e]);m.answer.ansLocs=[],m.locations=[],m.answer&&m.answer.family&&(m.answer.ansLocs=m.answer.family.split(":").map(Number)),d(m.answer)}function l(){for(var e=0;e<n.answers.length;e++)if(m.brothername==n.answers[e].name){for(var t=!1,a=0;a<m.answer.ansLocs.length;a++)if(m.answer.ansLocs[a]==n.answers[e].id){t=!0,console.log("flag repeated");break}n.answers[e].id==m.answer.id&&(console.log("flag2"),t=!0),t||(console.log("Added brother"),m.answer.ansLocs.push(n.answers[e].id))}console.log("@ addBrother ---\x3e vm.answer.ansLocs",m.answer.ansLocs),console.log("@ addBrother ---\x3e vm.answer",m.answer),d(),m.brothername=""}function d(){var e=0;if(m.answer.ansLocs){m.locations=[];for(var t=0;t<m.answer.ansLocs.length;t++)e=n.answers.map(function(e){return e.id}).indexOf(m.answer.ansLocs[t]),m.locations.push(n.answers[e])}}function u(e){for(var n=0;n<m.locations.length;n++)m.locations[n].id==e.id&&(m.locations.splice(n,1),m.answer.ansLocs.splice(n,1));d(),console.log("vm.answer ",m.answer)}function g(){o.confirmSiblings(m.answer,f)}function f(){var e=m.answer.ansLocs,n="";e.push(m.answer.id),console.log("bros - ",e);for(var t=0;t<e.length;t++){n="";for(var a=0;a<e.length;a++)t!=a&&(n=n+":"+e[a]);n=n.substring(1),i.updateAnswer(e[t],["family"],[n]),console.log("updated answer ",e[t]," brothers: ",n)}m.answer=void 0,m.locations=void 0,m.brothername="",m.answername=""}var m=this;m.title="sibLocs",m.selAns=c,m.addBrother=l,m.remAns=u,m.confirm=g,function(){r(),console.log("sibLocs page Loaded!")}()}angular.module("app").controller("sibLocs",e),e.$inject=["$location","$rootScope","$state","catans","$http","dialog","answer"]}(),function(){"use strict";function e(e,n,t,a,s,o,i,r,c,l,d){function u(){function e(e){return e}var t=new Date,a=t.getTimezoneOffset();t.setMinutes(t.getMinutes()-a);var s=e(t.getMonth()+1)+"/"+e(t.getDate())+"/"+t.getFullYear();P=o.date2number(s),g(),n.DEBUG_MODE&&console.log("rodconsole page Loaded!")}function g(){E=[],a.getall().then(function(e){E=e,E.forEach(function(e){if(e.datenum=o.date2number(e.date),e.category){var t=n.categories.map(function(e){return e.id}).indexOf(e.category);t>-1&&(e.title=n.categories[t].category.replace("@Nh","San Diego"),e.fimage=n.categories[t].fimage,e.introtext||null!=n.categories[t].introtext&&void 0!=n.categories[t].introtext&&""!=n.categories[t].introtext&&(e.introtext=n.categories[t].introtext),e.fc=n.categories[t].fc,e.bc=n.categories[t].bc,e.shade=n.categories[t].shade),void 0!=e.fimage&&""!=e.fimage?e.imageok=!0:e.imageok=!1,void 0!=e.introtext&&""!=e.introtext?e.textok=!0:e.textok=!1}}),R.dataReady=!0,R.rods=E}),R.addopts=[];for(var e=0;e<n.categories.length;e++)R.addopts.push(n.categories[e].category)}function f(){for(var e=0;e<n.categories.length;e++)R.addval==n.categories[e].category&&(console.log(R.rank.id,R.addval),a.update(R.rank.id,["category"],[n.categories[e].id]))}function m(e){if("all"==e&&(R.next20IsSelected=!1,R.allIsSelected=!0),"next20"==e&&(R.next20IsSelected=!0,R.allIsSelected=!1),R.rods=[],R.next20IsSelected)for(var n=0;n<E.length;n++)E[n].datenum>=P&&R.rods.push(E[n]);else R.rods=E}function p(e){R.overview=!1,R.detail=!0,R.addval="",R.rank=e,void 0!=R.rank.fimage&&""!=R.rank.fimage&&(R.rank.image3=R.rank.image2,R.rank.image2=R.rank.image1,R.rank.image1=R.rank.fimage),console.log("selRank",R.rank),console.log(R.rank.bc),null!=R.rank.bc?(O="h"!=R.rank.bc.charAt(0)?R.rank.bc:s.hsl2rgb(R.rank.bc),R.rank.bc2=s.shadeColor(O,R.rank.shade/10)):(R.rank.bc="hsl(240, 100%, 99%)",R.rank.bc2=s.shadeColor(R.rank.bc,-.3)),n.cmd1exe=!1}function h(){R.overview=!0,R.detail=!1}function w(){n.$emit("backToResults")}function v(){R.rank.shade=R.rank.shade+1,R.rank.shade>10&&(R.rank.shade=10),O=s.hsl2rgb(R.rank.bc),R.rank.bc2=s.shadeColor(O,R.rank.shade/10)}function k(){R.rank.shade=R.rank.shade-1,R.rank.shade<-10&&(R.rank.shade=-10),O=s.hsl2rgb(R.rank.bc),R.rank.bc2=s.shadeColor(O,R.rank.shade/10)}function y(){C?(R.rank.fimage=n.blobimage,R.rank.image1=R.rank.fimage):(R.rank.fimage=n.blobimage,R.rank.image3=R.rank.image2,R.rank.image2=R.rank.image1,R.rank.image1=R.rank.fimage),n.cmd1exe=!1}function b(){if(void 0!=R.rank.fimage&&""!=R.rank.fimage){var e=["fimage","bc","fc","shade"];"h"==R.rank.bc.charAt(0)&&(R.rank.bc=s.hsl2rgb(R.rank.bc)),"h"==R.rank.fc.charAt(0)&&(R.rank.fc=s.hsl2rgb(R.rank.fc));var t=[R.rank.fimage,R.rank.bc,R.rank.fc,R.rank.shade],a="",o=[];if(R.rank.isatomic)console.log("rank:",R.rank.title),c.update(R.rank.rankid,e,t).then(function(){i.getDialog("rodimageuploadsuccess"),loadData(),h()});else{R.dataReady=!1,R.loadText="Saving data...",a=R.rank.title.replace(" in San Diego","");for(var l=0;l<n.content.length;l++)n.content[l].title.indexOf(a)>-1&&o.push(c.update(n.content[l].id,e,t));r.all(o).then(function(){R.dataReady=!0,i.getDialog("rodimageuploadsuccess"),loadData(),h()})}}else i.getDialog("nouploadedimage")}function A(){d.update(R.rank.category,["introtext"],[R.rank.introtext]).then(function(){i.getDialog("introTextSaved"),g()});var e=R.rank.introtext;a.update(R.rank.id,["introtext"],[""]).then(function(){}),""==R.rank.introtext&&(R.rank.introtext=e)}function S(){if(void 0!=R.rank.fimage&&""!=R.rank.fimage){l.deleteBlob(R.rank.fimage);var e=n.content.map(function(e){return e.id}).indexOf(R.rank.rankid),t=s.defaultRankColor(n.content[e]),a=["fimage","bc","fc","shade"],o=["",t[0],t[1],0],d="",u=[];if(R.rank.isatomic)c.update(R.rank.rankid,a,o).then(function(){i.getDialog("rodimagedeletesuccess"),loadData(),h()});else{R.dataReady=!1,R.loadText="Deleting image...",d=R.rank.title.replace(" in San Diego","");for(var g=0;g<n.content.length;g++)n.content[g].title.indexOf(d)>-1&&u.push(c.update(n.content[g].id,a,o));r.all(u).then(function(){R.dataReady=!0,i.getDialog("rodimagedeletesuccess"),loadData(),h()})}}else i.getDialog("nouploadedimage")}var R=this;R.title="rodconsole",R.selRank=p,R.goBack=h,R.plusShade=v,R.minusShade=k,R.refreshImages=y,R.filterData=m,R.goSaveImage=b,R.goSaveText=A,R.goDeleteImage=S,R.addCategory=f,R.dataReady=!1;var E=[],P=0;R.overview=!0,R.detail=!1,R.rank={},R.sm=n.sm,R.allIsSelected=!0,R.next20IsSelected=!1,R.loadText="Loading data...";var C=!1;n.canswer={},n.canswer.id="featuredImages",R.testimage=n.EMPTY_IMAGE;var O="";n.$on("fileUploaded",function(e,a){n.cmd1exe=!!n.cmd1exe&&n.cmd1exe,"rodconsole"!=t.current.name||n.cmd1exe||(n.cmd1exe=!0,n.blobimage=a,y())}),i.enterPassword(u,w)}angular.module("app").controller("rodconsole",e),e.$inject=["$location","$rootScope","$state","rankofday","color","datetime","dialog","$q","table","imagelist","categories"]}(),function(){"use strict";function e(e,n,t,a){function s(){for(var e=0;e<o.queries.length;e++)a.deleteRec(o.queries[e].id)}var o=this;o.title="queries",o.clearDb=s,o.isAdmin=n.isAdmin,function(){a.getQueries().then(function(e){o.queries=e,console.log("Queries Loaded!")})}()}angular.module("app").controller("queries",e),e.$inject=["$location","$rootScope","$state","query"]}(),function(){"use strict";function e(e,n,t,a,s,o,i,r,c,l,d,u,g){function f(){console.log("Plan admin page Loaded!")}function m(e){o.changeCodePriceDlg(e,p)}function p(e,n){h.isSaving=!0,u.setCodePrice(e,n).then(function(n){h.isSaving=!1,"Custom Rank"==e.code?(h.notifications.push({message:"Custom Rank Price $ "+n.data.plan.amount/100+" has changed successfully",type:"success"}),e.price=n.data.plan.amount/100):(h.notifications.push({message:"Premium Plan "+e.code+" Price $ "+n.data.plan.amount/100+" has changed successfully",type:"success"}),e.price=n.data.plan.amount/100)}).catch(function(e){h.notifications.push({message:e.data.err.message,type:"error"})})}var h=this;h.title="plan",h.dataReady=!1,h.changeCodePrice=m,h.customranking={},h.notifications=[],h.isAdmin=n.isAdmin,h.isSaving=!1,function(){i.all([d.get(),u.getSetting()]).then(function(e){h.codeprices=e[0],h.STRIPE_COMMISSION_PERCENTAGE=e[1].STRIPE_COMMISSION_PERCENTAGE,h.CUSTOM_RANK_PRICE=e[1].CUSTOM_RANK_PRICE,h.customranking={code:"Custom Rank",price:h.CUSTOM_RANK_PRICE},h.codeprices.push(h.customranking),h.dataReady=!0,f()})}()}angular.module("app").controller("plan",e),e.$inject=["$location","$rootScope","$state","$stateParams","table","dialog","$q","useraccnt","promoter","answer","codeprice","setting","$timeout"]}(),function(){"use strict";function e(e,n,t,a,s,o,i,r,c,l,d,u,g){function f(){o.changeCommissionDlg(S.STRIPE_COMMISSION_PERCENTAGE,m)}function m(e){u.setSetting({STRIPE_COMMISSION_PERCENTAGE:parseInt(e)/100}).then(function(e){S.STRIPE_COMMISSION_PERCENTAGE=e.STRIPE_COMMISSION_PERCENTAGE})}function p(e){-1!=S.selectedPromoters.indexOf(e)?S.selectedPromoters.splice(S.selectedPromoters.indexOf(e),1):S.selectedPromoters.push(e)}function h(){S.selectedPromoters.forEach(function(e){S.payPromoter(e)})}function w(e){e.stripeid?r.payPromoter(e,S.STRIPE_COMMISSION_PERCENTAGE).then(function(n){S.notifications.push({message:"$"+e.balance*S.STRIPE_COMMISSION_PERCENTAGE+"transfered successfully to Promoter: "+e.firstname+" "+e.lastname,type:"success"}),e.lastPaymentDate=n.data.lastPaymentDate,e.payedThisMonth=!0}).catch(function(n){S.notifications.push({message:"$"+e.balance*S.STRIPE_COMMISSION_PERCENTAGE+"  to Promoter: "+e.firstname+" "+e.lastname+" transfer failed. ",type:"error"})}):window.alert("The promoter"+e.firstname+" "+e.lastname+" need to connect stipe account.")}function v(e){l.getAnswer(e.answer).then(function(n){e.answerObj=n})}function k(e){S.currentPromoter=e,S.detailview=!0,S.overview=!1}function y(){if(1==S.detailview)return S.overview=!0,void(S.detailview=!1)}function b(e){o.showBusinessDetailDlg(e,S.STRIPE_COMMISSION_PERCENTAGE,S.CUSTOM_RANK_PRICE)}function A(e){t.go("answerDetail",{index:e.slug})}var S=this;S.title="payment",S.dataReady=!1,S.promoters=[],S.isAdmin=n.isAdmin,S.detailview=!1,S.overview=!0,S.notifications=[],S.selectedPromoters=[],S.payPromoter=w,S.gotoanswer=A,S.goBack=y,S.goDetailView=k,S.showBusinessDetail=b,S.addOrRemovePromoter=p,S.paySelectedPromoters=h,S.changeCommission=f,function(){i.all([c.getall(),r.getallaccnts(),d.get(),u.getSetting()]).then(function(e){var t=e[1],a=e[2];S.STRIPE_COMMISSION_PERCENTAGE=e[3].STRIPE_COMMISSION_PERCENTAGE?e[3].STRIPE_COMMISSION_PERCENTAGE:.2,S.CUSTOM_RANK_PRICE=e[3].CUSTOM_RANK_PRICE,e[0].forEach(function(e){var s=angular.copy(e);s.businesses=[];for(var o=0;o<t.length;o++)if(t[o].promocode==e.code){var i=angular.copy(t[o]);"Basic"==i.status&&(i.style="background-color:#bfbfbf"),i.istrial?(i.status="On Trial "+Math.ceil(moment.duration(moment(i.discountEndDate)-moment()).asDays())+" Days left",i.style="background-color:#b3b300"):(i.status="Active",i.style="background-color:#009900");for(var r=0;r<a.length;r++)if(a[r].code==i.bizcat){i.price=a[r].price;break}i.totalCommission=0,i.ispremium&&(i.totalCommission+=i.price*S.STRIPE_COMMISSION_PERCENTAGE),i.hasranks&&(i.totalCommission+=i.ranksqty*S.CUSTOM_RANK_PRICE*S.STRIPE_COMMISSION_PERCENTAGE),s.businesses.push(i),v(s.businesses[s.businesses.length-1])}for(s.payedThisMonth=!0,s.lastPaymentDate||(s.payedThisMonth=!1),(moment(s.lastPaymentDate).year()==moment(n.setting.serverDate).year()&&moment(s.lastPaymentDate).month()<moment(n.setting.serverDate).month()||moment(s.lastPaymentDate).year()<moment(n.setting.serverDate).year())&&(s.payedThisMonth=!1),s.balance=0,o=0;o<s.businesses.length;o++)"Active"==s.businesses[o].status&&(s.balance+=s.businesses[o].monthlyCost);s.activeCount=s.businesses.filter(function(e){return"Active"==e.status}).length,s.ontrialCount=s.businesses.filter(function(e){return-1!=e.status.indexOf("On Trial")}).length,S.promoters.push(s)}),S.dataReady=!0})}(),function(){console.log("payment admin page Loaded!")}()}angular.module("app").controller("payment",e),e.$inject=["$location","$rootScope","$state","$stateParams","table","dialog","$q","useraccnt","promoter","answer","codeprice","setting","$timeout"]}(),function(){"use strict";function e(e,n,t,a,s,o,i){function r(){console.log("@getData"),console.log("$rootScope.catansrecs.length ",n.catansrecs.length),h.idx=w;var e={},t={},a=0,s=0;h.ans1=n.dupAns[w].ans1,h.ans2=n.dupAns[w].ans2,g(),h.ans1.catans=[],a=h.ans1.id;for(var o=0;o<n.catansrecs.length;o++)if(a==n.catansrecs[o].answer){e=n.catansrecs[o];for(var i=0;i<n.content.length;i++)n.catansrecs[o].category==n.content[i].id&&(e.rank=n.content[i].title);h.ans1.catans.push(e)}h.ans2.catans=[],s=h.ans2.id;for(var o=0;o<n.catansrecs.length;o++)if(s==n.catansrecs[o].answer){t=n.catansrecs[o];for(var i=0;i<n.content.length;i++)n.catansrecs[o].category==n.content[i].id&&(t.rank=n.content[i].title);h.ans2.catans.push(t)}console.log("vm.ans1.catans.length ",h.ans1.catans.length),console.log("vm.ans2.catans.length ",h.ans2.catans.length)}function c(e){w-=e,w<0&&(w=0),r()}function l(e){w+=e,w>=h.tot&&(w=h.tot),r()}function d(e){1==e&&(o.deleteAnswer(n.dupAns[w].ans1.id),a.deleteAnswer(n.dupAns[w].ans1.id)),2==e&&(o.deleteAnswer(n.dupAns[w].ans2.id),a.deleteAnswer(n.dupAns[w].ans2.id))}function u(e){if(1==e){h.addcts1opts=[];for(var n="",t=0;t<v.length;t++)v[t].indexOf("@neighborhood")>-1?(n=v[t].replace("@neighborhood",h.ans1.cityarea),h.addcts1opts.push(n)):h.addcts1opts.push(v[t]);h.addcts1active=!0}if(2==e){h.addcts2opts=[];for(var a="",t=0;t<v.length;t++)v[t].indexOf("@neighborhood")>-1?(a=v[t].replace("@neighborhood",h.ans2.cityarea),h.addcts2opts.push(a)):h.addcts2opts.push(v[t]);h.addcts2active=!0}}function g(){v=[];for(var e="",t=0;t<n.content.length;t++)n.content[t].title.indexOf("in Hillcrest")>-1&&(e=n.content[t].title.replace("Hillcrest","@neighborhood"),v.push(e)),n.content[t].ismp&&v.push(n.content[t].title)}function f(e){var t="",s={},o=0;1==e&&(t=h.addcts1val,s=h.ans1,void 0!=h.cat1isdup&&h.cat1isdup),2==e&&(t=h.addcts2val,s=h.ans2,void 0!=h.cat2isdup&&h.cat2isdup);for(var i=0;i<n.content.length;i++)if(n.content[i].title==t){o=n.content[i].id;break}a.postRec2(s.id,o),1==e&&(h.addcts1active=!1),2==e&&(h.addcts2active=!1),setTimeout(function(){r()},1e3)}function m(e){a.deleteRec(e.answer,e.category),setTimeout(function(){r()},1e3)}function p(e){1==e&&t.go("editAnswer",{index:h.ans1.id}),2==e&&t.go("editAnswer",{index:h.ans2.id})}var h=this;h.title="mergeAnswers";var w=0;h.goPrev=c,h.goNext=l,h.delAnswer=d,h.addCatans=u,h.addcts=f,h.delCatans=m,h.editAnswer=p,h.addcts1active=!1,h.addcts2active=!1;var v=[];!function(){h.tot=n.dupAns.length-1,g(),r(),console.log("mergeAnswers page Loaded!")}()}angular.module("app").controller("mergeAnswers",e),e.$inject=["$location","$rootScope","$state","catans","$http","answer","$stateParams"]}(),function(){"use strict";function e(e,n,t,a,s,o){function i(){h.locs=[];var n={},t=[];h.locations=e.locations.slice(1),h.locations.forEach(function(a){t=a.sub_areas.split(",").map(Number),a.sa=[],t.forEach(function(t){var s=e.locations.map(function(e){return e.id}).indexOf(t);s>-1&&(n={},n.id=t,n.name=e.locations[s].nh_name,n.sel=!0,a.sa.push(n))}),a.sel=!1,h.locs.push(a.nh_name)})}function r(){var n="";h.locations.forEach(function(e){n+=","+e.id}),n=n.substring(1),console.log("str - ",n);var t=e.locations.map(function(e){return e.nh_name}).indexOf("San Diego");o.update(e.locations[t].id,["sub_areas"],[n])}function c(){h.showAddLocation=!0}function l(){var n={};n.nh_name=h.locname,n.cityid=e.locations[0].cityid,n.cityname=e.locations[0].cityname,n.sub_areas="",o.addLocation(n).then(function(){h.showAddLocation=!1,i()})}function d(e){h.locations.forEach(function(e){e.sel=!1}),e.sel=!0}function u(e){e.sel?e.sel=!1:e.sel=!0}function g(n){var a={};a.sel=!0,a.name=h.newsa;var s=e.locations.map(function(e){return e.nh_name}).indexOf(h.newsa);s>-1?(a.id=e.locations[s].id,n.sa.push(a),h.newsa=""):t.getDialog("subAreaInvalid")}function f(n){var t="";n.sa.forEach(function(e){e.sel&&(t+=","+e.id)}),t=t.substring(1),e.DEBUG_MODE&&console.log("str - ",t),o.update(n.id,["sub_areas"],[t]),n.sel=!1,i()}function m(e){o.deleteRec(e.id).then(function(){i()})}function p(e){e.sel=!1}var h=this;h.title="locations",h.getLocations=i,h.update=r,h.enableAddLocation=c,h.addLocation=l,h.editLocation=d,h.selsa=u,h.addsa=g,h.savesa=f,h.deleteloc=m,h.cancel=p,function(){h.showAddLocation=!1,h.opts=["San Diego"],h.locs=[],e.DEBUG_MODE&&console.log("locations page Loaded!")}()}angular.module("app").controller("locations",e),e.$inject=["$rootScope","staticpages","dialog","SERVER_URL","$timeout","locations"]}(),function(){"use strict";function e(e,n,t,a){function s(){r.uuis=e.uuis}function o(e){n.deleteRecord(e.id).then(s)}function i(o){var i=e.answers.map(function(e){return e.id}).indexOf(o.answer);e.answers[i].imageurl==o.imageurl&&a.updateAnswer(e.answers[i].id,["imageurl"],[e.EMPTY_IMAGE]),t.deleteBlob(o.imageurl),n.deleteRecord(o.id).then(s)}var r=this;r.title="imagesmod",r.dataready=!1,r.removeImage=i,r.approveImage=o,function(){n.getRecords().then(function(){r.dataready=!0,s()}),e.DEBUG_MODE&&console.log("imagesmod page Loaded!")}()}angular.module("app").controller("imagesmod",e),e.$inject=["$rootScope","useruploadedimages","imagelist","answer"]}(),function(){"use strict";function e(e,n,t,a,s,o,i){function r(){console.log("getRanks");for(var e="",t=0;t<n.content.length;t++)n.content[t].tags.indexOf("food")>-1&&(e=e+":"+n.content[t].id);for(var s=e.substring(1),o=s.split(":").map(Number),i={},r=0,l=0,u=[],g=!1,f="",t=0;t<n.catansrecs.length;t++){i=n.catansrecs[t];for(var m=0;m<o.length;m++)if(i.category==o[m]){if(r=i.answer,l=n.answers.map(function(e){return e.id}).indexOf(r),l<0&&(console.log("idx - ",r,"catansrec - ",i.id,i.answer,i.category),a.deleteRec(i.answer,i.category)),g=!1,u.length>0&&l>0)for(var p=0;p<u.length;p++)if(u[p].id==n.answers[l].id){g=!0;break}g||(f=f+":"+n.answers[l].id,u.push(n.answers[l]))}}d=u.map(function(e){return e.id}),c(0),console.log("Answers Ids: - ",f.substring(1)),console.log("Food answers length: - ",u.length)}function c(e){d.indexOf(n.answers[e].id)>-1?(o.updateAnswer(n.answers[e].id,["isfood"],[!0]),i(function(){e++,console.log(e," ",n.answers[e].name,", isfood is TRUE"),e<n.answers.length&&c(e)},100)):(o.updateAnswer(n.answers[e].id,["isfood"],[!1]),i(function(){e++,console.log(e," ",n.answers[e].name,", isfood is FALSE"),e<n.answers.length&&c(e)},100))}var l=this;l.title="foodRanks";var d=[];l.getRanks=r,function(){console.log("foodRanks page Loaded!")}()}angular.module("app").controller("foodRanks",e),e.$inject=["$location","$rootScope","$state","catans","$http","answer","$timeout"]}(),function(){"use strict";function e(e,n,t,a,s,o,i){function r(){a.getFlags().then(function(e){m.flags=e,console.log("flags - ",m.flags);for(var n=0;n<m.flags.length;n++){if("comment-rank"==m.flags[n].type||"comment-answer"==m.flags[n].type)switch(m.flags[n].flag){case 1:m.flags[n].desc="Off-Topic";break;case 2:m.flags[n].desc="Offensive";break;case 3:m.flags[n].desc="Spam"}if("answer"==m.flags[n].type)switch(m.flags[n].flag){case 1:m.flags[n].desc="Wrong Category";break;case 2:m.flags[n].desc="No longer active";break;case 3:m.flags[n].desc="Offensive";break;case 4:m.flags[n].desc="Spam"}}})}function c(e){"answer"==e.type&&t.go("answerDetail",{index:e.number}),"comment-answer"==e.type&&t.go("answerDetail",{index:e.number}),"comment-rank"==e.type&&t.go("rankSummary",{index:e.number})}function l(e){m.viewTable=!1,m.viewDetails=!0;var t={};if(m.data={},m.catans=[],m.comments=[],m.data.type=e.type,m.data.desc=e.desc,m.data.id=e.id,"answer"==e.type){var a=n.answers.map(function(e){return e.id}).indexOf(e.number);m.data.imageurl=n.answers[a].imageurl,m.data.name=n.answers[a].name,m.data.location=n.answers[a].location,m.data.cityarea=n.answers[a].cityarea,m.data.phone=n.answers[a].phone,m.data.website=n.answers[a].website,m.data.addinfo=n.answers[a].addinfo;for(var s=0;s<n.catansrecs.length;s++)if(n.answers[a].id==n.catansrecs[s].answer){t={},t=n.catansrecs[s];for(var r=0;r<n.content.length;r++)n.catansrecs[s].category==n.content[r].id&&(t.rank=n.content[r].title);m.catans.push(t)}}if("comment-answer"==e.type){var a=n.answers.map(function(e){return e.id}).indexOf(e.number);m.data.imageurl=n.answers[a].imageurl,m.data.name=n.answers[a].name,m.data.location=n.answers[a].location,m.data.cityarea=n.answers[a].cityarea,m.data.phone=n.answers[a].phone,m.data.website=n.answers[a].website,m.data.addinfo=n.answers[a].addinfo,i.getcommentsbyanswer(e.number).then(function(e){m.comments=e})}if("comment-rank"==e.type){var a=n.content.map(function(e){return e.id}).indexOf(e.number);m.data.title=n.content[a].title,o.getcommentsbyrank(e.number).then(function(e){m.comments=e})}}function d(){m.viewTable=!0,m.viewDetails=!1}function u(e){s.deleteRec(e.answer,e.category)}function g(e){"comment-rank"==m.data.type&&o.deletecomment(e.id),"comment-answer"==m.data.type&&i.deletecomment(e.id)}function f(e){a.deleteFlag(e.id).then(function(){r()})}var m=this;m.title="flags",m.getFlags=r,m.gotoView=c,m.delCatans=u,m.delComment=g,m.seeDetails=l,m.seeFlags=d,m.deleteFlag=f,m.viewDetails=!1,m.viewTable=!0,function(){console.log("Flags page loaded!")}()}angular.module("app").controller("flags",e),e.$inject=["$location","$rootScope","$state","flag","catans","comment","comment2"]}(),function(){"use strict";function e(e,n,t,a,s,o,i,r){function c(){console.log("query Answer"),u.ansRes=[];for(var e=0,t={},a=0;a<n.answers.length;a++)n.answers[a].name.indexOf(u.val)>-1&&u.ansRes.push(n.answers[a]);for(var s=0;s<u.ansRes.length;s++){u.ansRes[s].catans=[],e=u.ansRes[s].id;for(var o=0;o<n.catansrecs.length;o++)if(e==n.catansrecs[o].answer){t=n.catansrecs[o];for(var i=0;i<n.content.length;i++)n.catansrecs[o].category==n.content[i].id&&(t.rankid=n.content[i].id,t.catid=n.content[i].cat,t.title=n.content[i].title);u.ansRes[s].catans.push(t)}}}function l(e){
r.deleteRec(e.answer,e.category)}function d(e){i.deleteAnswer(e.id)}var u=this;u.title="dbQuery",u.queryAnswer=c,u.delCatans=l,u.delAnswer=d,u.isAdmin=n.isAdmin||n.dataAdmin,function(){u.isDET=n.isLoggedIn&&(12==n.user.id||30==n.user.id||41==n.user.id||42==n.user.id||30==n.user.id),console.log("dbQuery page Loaded!")}()}angular.module("app").controller("dbQuery",e),e.$inject=["$location","$rootScope","$state","$stateParams","table","dialog","answer","catans"]}(),function(){"use strict";function e(e,n,t,a,s,o,i,r,c,l,d,u,g,f,m,p,h){function w(){var e={},t=!1;z.unrefans=[],z.addctsopts=[],z.ans=-1;for(var a=0;a<n.answers.length;a++){({}),e={},e=n.answers[a],t=!1;for(var s=0;s<n.catansrecs.length;s++)if(n.catansrecs[s].answer==e.id){t=!0;break}0==t&&z.unrefans.push(e)}if(z.unrefans.length>0)for(var o=0;o<n.content.length;o++)z.addctsopts.push(n.content[o].title)}function v(e){l.deleteAnswer(e.id).then(function(){w()})}function k(e){z.ans=e.id}function y(e){var t="",a=0;t=z.addctsval;for(var s=0;s<n.content.length;s++)if(n.content[s].title==t){a=n.content[s].id;break}d.postRec2(z.ans,a).then(function(){w()})}function b(){console.log("@ Show Possible Duplicated"),console.log("answers length",n.answers.length);var e={},t={};z.dupAnswers=[];for(var a=0,s=0,o="",i=0;i<n.answers.length;i++)if(s=.75*n.answers[i].name.length,e=n.answers[i],o=n.answers[i].name.slice(0,s),"Establishment"==n.answers[i].type&&o.length>8)for(var r=0;r<n.answers.length;r++)n.answers[r].name.indexOf(o)>-1&&i!=r&&(t={},t.id=a,t.add1=e.addinfo,t.nh1=e.cityarea,t.loc1=e.location,t.name1=e.name,t.image1=e.imageurl,t.id1=e.id,t.name2=n.answers[r].name,t.idx1=i,t.idx2=r,t.loc2=n.answers[r].location,t.nh2=n.answers[r].cityarea,t.add2=n.answers[r].addinfo,t.image2=n.answers[r].imageurl,t.id2=n.answers[r].id,z.dupAnswers.push(t),a++);console.log("finished")}function A(e){for(var t=0;t<n.catansrecs.length;t++)if(e.id2==n.catansrecs[t].answer){d.updateRec(n.catansrecs[t].id,["answer"],[e.id1]);break}l.deleteAnswer(e.id2),b()}function S(e){for(var t=0;t<n.catansrecs.length;t++)if(e.id1==n.catansrecs[t].answer){d.updateRec(n.catansrecs[t].id,["answer"],[e.id2]);break}l.deleteAnswer(e.id1),b()}function R(){n.dupAns=[];var e={},t={};z.dupAnsNames=[];for(var a=0,s=0;s<n.answers.length;s++){e=n.answers[s];for(var o=0;o<n.answers.length;o++)e.name==n.answers[o].name&&e.location==n.answers[o].location&&s!=o&&(!1,t={},t.ans1=e,t.ans2=n.answers[o],n.dupAns.push(t),z.dupAnsRdy=!0,a++)}}function E(){n.fields=n.typeSchema[6].fields;for(var e={},t={},a=[],s=0,o=0;o<n.answers.length;o++)if(e=n.answers[o],void 0!=e.location&&""!=e.location)for(var i=0;i<n.answers.length;i++)void 0!=n.answers[i].location&&""!=n.answers[i].location&&e.location==n.answers[i].location&&o!=i&&(t={},t.ans1=e,t.ans2=n.answers[i],a.push(t),s++);n.dupAns=a,console.log("@finished - showDuplicatedByLocation"),z.dupAnsRdy=!0}function P(){t.go("mergeAnswers")}function C(){}function O(){for(var e=[],t=0;t<n.content.length;t++)for(var a=t;a<n.content.length;a++)n.content[t].title==n.content[a].title&&t!=a&&(console.log("duplicated rank --- ",n.content[t].title),e.push(n.content[t]))}function I(){console.log("Clearing all catans vote sums to zero")}function x(){console.log("syncUSerVotes"),u.loadAllVotes().then(function(e){n.allvotes=e,$()})}function $(){console.log("syncVotes");var e={},t={},a=[],s=[],o=0,i=0;z.syncp=[];for(var r={},c=0;c<n.catansrecs.length;c++){e=n.catansrecs[c],a=[],s=[],t={};for(var l=0;l<n.allvotes.length;l++)t=n.allvotes[l],t.catans==e.id&&(1==t.vote&&a.push(t),-1==t.vote&&s.push(t));a.length==e.upV&&s.length==e.downV||(r={},o=n.answers.map(function(e){return e.id}).indexOf(e.answer),i=n.content.map(function(e){return e.id}).indexOf(e.category),-1==o?(console.log("can not find answer ",e.answer),d.deleteCatan(e.id)):-1==i?(console.log("can not find ranking ",e.category),d.deleteCatan(e.id)):(r.answername=n.answers[o].name,r.categorytitle=n.content[i].title,r.answer=n.answers[o].id,r.catans=e.id,r.category=n.content[i].id,r.caUpV=e.upV,r.caDownV=e.downV,r.nUpVlen=a.length,r.nDownVlen=s.length,r.upVotes=a,r.downVotes=s,z.syncp.push(r)))}console.log("vm.syncp.length - ",z.syncp.length)}function D(){for(var e=0;e<z.syncp.length;e++)T(z.syncp[e])}function T(e){d.updateRec(e.catans,["upV","downV"],[e.nUpVlen,e.nDownVlen])}function M(e){for(var t=!1,a=0;a<n.allvotes.length;a++)e.user==n.allvotes[a].user&&e.vote==n.allvotes[a].vote&&e.catans==n.allvotes[a].catans&&e.answer==n.allvotes[a].answer&&(t&&u.deleteRec(n.allvotes[a].id),t=!0)}function _(){console.log("@estDistances, need to have GPS location stored-",n.answers.length),z.ans=-1,z.answerdist=[];for(var e=.017453292519943295,t=Math.cos,a=0,s=n.currentUserLatitude,o=n.currentUserLongitude,i=0,r=0,c=0,l={},d=0;d<n.answers.length;d++)"Establishment"==n.answers[d].type&&void 0!=n.answers[d].location&&""!=n.answers[d].location&&(i=n.answers[d].lat,r=n.answers[d].lng,l=n.answers[d],a=.5-t((i-s)*e)/2+t(s*e)*t(i*e)*(1-t((r-o)*e))/2,c=12742*Math.asin(Math.sqrt(a))/1.609,l.dist=c,(c>100||NaN==c)&&z.answerdist.push(l))}function L(e){t.go("answerDetail",{index:e.id})}function N(){for(var e=[],t={},a=1256,s=0;s<n.answers.length;s++)n.answers[s].imageurl.indexOf("http://")>-1&&(t={},t.id=a++,t.answer=n.answers[s].id,t.url=n.answers[s].imageurl,e.push(t));console.log(JSON.stringify(e))}function U(){var e=[],n="";f.get("../../../assets/images.json").then(function(t){e=t.data;for(var a=0;a<e.length;a++)e[a].url.indexOf("jpg")>-1&&(n="jpg"),e[a].url.indexOf("png")>-1&&(n="png"),e[a].url.indexOf("jpeg")>-1&&(n="jpeg"),l.updateAnswer(e[a].answer,["image"],["https://rankx.blob.core.windows.net/sandiego/"+e[a].answer+"/"+e[a].id+"."+n])})}function F(){var e={},t="";z.codes=[],z.catcode={},z.ans=-1;var a=m.get(),s=p.get();return o.all([a,s]).then(function(a){n.catcodes=a[0],n.codeprices=a[1];for(var s=0;s<n.codeprices.length;s++)z.codes.push(n.codeprices[s].code);console.log("Category-codes loaded..."),z.ansNoCode=[];for(var o=0;o<n.answers.length;o++)if(("Establishment"==n.answers[o].type||"PersonCust"==n.answers[o].type)&&(e={},e=n.answers[o],void 0==(t=h.getBizCat(e.id))||""==t||null==t)){e.cats=[];for(var i=0;i<n.catansrecs.length;i++)if(n.catansrecs[i].answer==e.id)for(var r=0;r<n.content.length;r++)n.content[r].id==n.catansrecs[i].category&&e.cats.push(n.content[r].title);z.ansNoCode.push(e)}})}function B(){m.post(z.catcode).then(function(){console.log("Added category code pair"),F()})}function q(e){console.log("selEditAddess - ",e),z.ans=e.id}function j(e){i.getLocationGPS(e).then(function(){l.updateAnswer(e.id,["location","lat","lng"],[e.location,e.lat,e.lng]).then(function(){_()})})}function G(){}function V(){z.catstrmode=!0;for(var e=0,t="",a=[],s=[],o=0;o<n.content.length;o++){a=[],g.getInclusiveAreas(n.content[o].nh,a),s=[];for(var i=0;i<n.content.length;i++)if(n.content[o].cat==n.content[i].cat)for(var c=0;c<a.length;c++)a[c]==n.content[i].nh&&-1==s.indexOf(n.content[i].id)&&s.push(n.content[i].id);t="";for(var l=0;l<s.length;l++)t=t+":"+s[l];t=t.substring(1),r.update(n.content[o].id,["catstr"],[t]).then(function(){e++,z.cpct=Math.floor(e/n.content.length*100)})}}var z=this;z.title="dbMaint",z.showUrefAns=w,z.delAnswer=v,z.selAns=k,z.showPossibleDuplicated=b,z.syncToFirst=A,z.syncToSecond=S,z.showDuplicatedOnlyName=R,z.showDuplicatedByLocation=E,z.findPhoneWebsite=C,z.findDuplicatedRanks=O,z.clearAllCatansVotes=I,z.syncUserVotes=x,z.getAnswerBizCode=F,z.updatecatans=T,z.estDistances=_,z.gotoAnswer=L,z.createImagesJSON=N,z.updateUrls=U,z.goMerge=P,z.getSlugs=G,z.delAnswer=v,z.addcts=y,z.selEditAddress=q,z.editAddress=j,z.addcatcode=B,z.categoryStr=V,z.deleteDupVotes=M,z.fixAll=D,z.isAdmin=n.isAdmin,z.dupAnsRdy=!1,z.catstrmode=!1,function(){console.log("dbMaint page Loaded!")}()}angular.module("app").controller("dbMaint",e),e.$inject=["$location","$rootScope","$state","$stateParams","Upload","$q","getgps","table","dialog","answer","catans","votes","common","$http","categorycode","codeprice","useraccnt"]}(),function(){"use strict";function e(e,n,t,a,s,o,i,r,c,l,d,u,g,f,m,p,h,w,v,k){function y(e){t.go("answerDetail",{index:e.slug})}function b(){$.filteredCatans=[];var e=_.groupBy($.catans,function(e){return"cat"+e.category+"answer"+e.answer});for(var n in e)e[n].length>1&&(e[n].dup=e[n].length,$.filteredCatans.push(e[n]));$.deletingCatans=!1,$.dtInstanceCatans={},g(function(){$.dtInstanceCatans.rerender()},1e3)}function A(){$.deletingCatans=!0;var e=$.filteredCatans.filter(function(e){return e[0].checked}),n=[];e.forEach(function(e){for(var t=1;t<e.length;t++)n.push(p.deleteCatan(e[t].id))}),i.all(n).then(function(e){e.forEach(function(e){var n=$.catans.map(function(e){return e.id}).indexOf(e.resource[0].id);$.catans.splice(n,1)}),b()})}function S(){$.filteredCategories=[];var e=$.rankings.map(function(e){return e.cat});$.filteredCategories=$.categories.filter(function(n){return-1==e.indexOf(n.id)}),$.deletingCategories=!1,$.dtInstanceCategories={},g(function(){$.dtInstanceCategories.rerender()},1e3)}function R(){$.deletingCategories=!0;var e=$.filteredCategories.filter(function(e){return e.checked}),n=[];e.forEach(function(e){n.push(h.deleteRec(e.id))}),i.all(n).then(function(e){e.forEach(function(e){var n=$.categories.map(function(e){return e.id}).indexOf(e.id);$.categories.splice(n,1)}),S()})}function E(){$.filteredAnswers=[];var e=$.catans.map(function(e){return e.answer});$.filteredAnswers=$.answers.filter(function(n){return-1==e.indexOf(n.id)}),$.deletingAnswers=!1,$.dtInstanceAnswers={},g(function(){$.dtInstanceAnswers.rerender()},1e3)}function P(){$.deletingAnswers=!0;var e=$.filteredAnswers.filter(function(e){return e.checked}),n=[];e.forEach(function(e){n.push(l.deleteAnswer(e.id))}),i.all(n).then(function(e){e.forEach(function(e){var n=$.answers.map(function(e){return e.id}).indexOf(e.id);$.answers.splice(n,1)}),E()})}function C(){$.filteredRankings=[];var e=$.catans.map(function(e){return e.category});$.filteredRankings=$.rankings.filter(function(n){return-1==e.indexOf(n.id)}),$.deletingRankings=!1,$.dtInstanceRankings={},g(function(){$.dtInstanceRankings.rerender()},1e3)}function O(){$.deletingRankings=!0;var e=$.filteredRankings.filter(function(e){return e.checked}),n=[];e.forEach(function(e){n.push(s.deleteTable(e.id))}),i.all(n).then(function(e){e.forEach(function(e){var n=$.rankings.map(function(e){return e.id}).indexOf(e.id);$.rankings.splice(n,1)}),C()})}function I(){$.filteredFImages=[];var e=$.categories.map(function(e){return e.fimage});$.filteredFImages=$.fimages.filter(function(n){return-1==e.indexOf(n.url)}),$.deletingFImages=!1,$.dtInstanceFImages={},g(function(){$.dtInstanceFImages.rerender()},1e3)}function x(){$.deletingFImages=!0;var e=$.filteredFImages.filter(function(e){return e.checked}),n=[];e.forEach(function(e){n.push(k.deleteBlob(e.url))}),i.all(n).then(function(n){e.forEach(function(e){var n=$.fimages.map(function(e){return e.url}).indexOf(e.url);$.fimages.splice(n,1)}),I()})}var $=this;$.title="cleandb",$.dataReady=!1,$.catans=[],$.accounts=[],$.rankings=[],$.categories=[],$.answers=[],$.fimages=[],$.isAdmin=n.isAdmin,$.notifications=[],$.gotoanswer=y,$.filterCatans=b,$.filterCategories=S,$.filterAnswers=E,$.filterRankings=C,$.filterFImages=I,$.deleteSelectedCatans=A,$.deleteSelectedCategories=R,$.deleteSelectedAnswers=P,$.deleteSelectedRankings=O,$.deleteSelectedFImages=x,$.dtInstanceCatans={},$.dtInstanceCategories={},$.dtInstanceAnswers={},$.dtInstanceRankings={},$.dtInstanceFImages={},$.filteredCatans=[],$.filteredCategories=[],$.filteredAnswers=[],$.filteredRankings=[],$.filteredFImages=[],function(){i.all([p.getAllcatans(),r.getallaccnts(),h.getAllCategories(),v.getAllLocations(),s.getTables(),l.getAnswers(),k.getFeatureImageList()]).then(function(e){$.catans=e[0],$.accounts=e[1],$.categories=e[2],$.locations=e[3],n.categories=e[2],n.locations=e[3],n.content=e[4],w.unwrap(),$.rankings=n.content,$.answers=e[5],$.fimages=e[6],console.log("vm.fimages - ",$.fimages),$.dataReady=!0,b(),S(),E(),C(),I()})}()}angular.module("app").controller("cleandb",e),e.$inject=["$location","$rootScope","$state","$stateParams","table","dialog","$q","useraccnt","promoter","answer","codeprice","setting","$timeout","DTOptionsBuilder","DTColumnDefBuilder","catans","categories","dataloader","locations","imagelist"]}(),function(){"use strict";function e(e,n,t,a,s,o,i,r,c,l,d,u,g,f,m){function p(){console.log("bizadmin page Loaded!")}function h(e){return l.getAnswer(e.answer).then(function(n){e.answerObj=n})}function w(e){t.go("answerDetail",{index:e.slug})}function v(){return 1==R.showFilter?R.filtered=R.businesses.filter(function(e){return e.hasranks||e.haspremium}):2==R.showFilter?R.filtered=R.businesses.filter(function(e){return!(e.hasranks||e.haspremium)}):(R.loading=!1,R.dtInstance.rerender(),R.filtered=R.businesses)}function k(){R.showFilter=1,v()}function y(){R.showFilter=2,v()}function b(){R.showFilter=0,v()}function A(){R.showUserFilter=!R.showUserFilter,v()}function S(){console.log(R.filtered.filter(function(e){return e.checked}).map(function(e){return e}))}var R=this;R.title="bizadmin",R.dataReady=!1,R.businesses=[],R.isAdmin=n.isAdmin,R.notifications=[],R.gotoanswer=w,R.filterData=v,R.showFilter=0,R.showUserFilter=!0,R.setShowPurchases=k,R.setShowAll=b,R.setShowNonPurchases=y,R.showUser=A,R.deleteSelected=S,R.dtInstance={},R.filtered=[],R.loading=!1,function(){i.all([r.getallaccnts(),u.getSetting(),d.get()]).then(function(e){e[0],e[2],R.STRIPE_COMMISSION_PERCENTAGE=e[1].STRIPE_COMMISSION_PERCENTAGE?e[1].STRIPE_COMMISSION_PERCENTAGE:.2,R.CUSTOM_RANK_PRICE=e[1].CUSTOM_RANK_PRICE,e[0].forEach(function(e){var t=angular.copy(e);n.answers.map(function(e){return e.id}).indexOf(t.answer)>-1&&(h(t).then(function(){v()}),R.businesses.push(t))}),R.dataReady=!0,v()}),p()}()}angular.module("app").controller("bizadmin",e),e.$inject=["$location","$rootScope","$state","$stateParams","table","dialog","$q","useraccnt","promoter","answer","codeprice","setting","$timeout","DTOptionsBuilder","DTColumnDefBuilder"]}(),function(){"use strict";function e(e,n,t,a,s,o,i){function r(){e.answers.forEach(function(e){void 0!=e.imageurl&&-1==e.imageurl.indexOf("noimage.jpg")&&-1==e.imageurl.indexOf("rankx.blob.core")&&"Short-Phrase"!=e.type&&(d.ansimgs.push(e),console.log(e.name,e.imageurl))})}function c(){u<d.ansimgs.length&&(d.inprogress=!0,l(d.ansimgs[u].imageurl,d.ansimgs[u].slug,d.ansimgs[u].id).then(function(){console.log("processing image success - ",d.ansimgs[u].slug),u++,d.cpct=u/d.ansimgs.length*100,c()},function(e){console.log("there was error processing image: ",e),u++,d.cpct=u/d.ansimgs.length*100,c()}))}function l(e,n,t){return o({method:"POST",url:"https://server.rank-x.com/ImageServer/SaveImage",headers:{"X-Dreamfactory-API-Key":void 0,"X-DreamFactory-Session-Token":void 0},data:{imageurl:e,filename:n,answerid:t}})}var d=this;d.title="answerimages",d.ansimgs=[];var u=0;d.processAllImages=c,function(){r(),e.DEBUG_MODE&&console.log("answerimages page Loaded!")}()}angular.module("app").controller("answerimages",e),e.$inject=["$rootScope","staticpages","dialog","SERVER_URL","$timeout","$http","answer"]}(),function(){"use strict";function e(e,n,t,a,s,o,i,r,c,l,d,u,g,f,m,p,h,w,v,k,y){function b(){var n=t.getTables(),i=s.getAllCategories(),d=g.getAllLocations(),v=a.getAllAnswers(),k=f.getSpecials(),y=m.GetMatchTable(),b=p.getAllUserActivity(),A=l.getAllcatans(),S=h.getEdits(),R=c.getAllvrows(),E=o.getTables(),P=w.getallaccnts();return r.all([n,i,d,v,k,y,b,A,S,R,E,P]).then(function(n){e.content=n[0],e.categories=n[1],e.locations=n[2],e.answers=n[3],e.specials=n[4],e.mrecs=n[5],e.alluseractivity=n[6],e.catansrecs=n[7],e.edits=n[8],e.cvrows=n[9],e.customranks=n[10],e.useraccnts=n[11],u.unwrap(),u.createSearchStrings(),G.dataready=!0})}function A(){B(),G.selKeywords="active",n.go("queries")}function S(){B(),G.selViews="active",n.go("views")}function R(){B(),G.selFlags="active",n.go("flags")}function E(){B(),G.selRankings="active",n.go("addRank")}function P(){B(),G.selDbMaint="active",n.go("dbMaint")}function C(){B(),G.selQuery="active",n.go("dbQuery")}function O(){B(),G.selUpdate="active",n.go("updateHeaders")}function I(){B(),G.selFoodRanks="active",n.go("foodRanks")}function x(){B(),G.selSibLocks="active",n.go("sibLocs")}function $(){B(),G.selPayment="active",n.go("payment")}function D(){B(),G.selPlan="active",n.go("plan")}function T(){B(),G.selBizAdmin="active",n.go("bizadmin")}function M(){B(),G.selCleanDB="active",n.go("cleandb")}function _(){B(),G.selimagesMod="active",n.go("imagesmod")}function L(){B(),G.selStaticPages="active",n.go("staticpagesconsole")}function N(){B(),G.selLocations="active",n.go("locations")}function U(){B(),G.selsitemap="active",n.go("sitemap")}function F(){B(),G.selanswerimages="active",n.go("answerimages")}function B(){G.selKeywords="",G.selViews="",G.selFlags="",G.selRankings="",G.selDbMaint="",G.selQuery="",G.selUpdate="",G.selFoodRanks="",G.selPlan="",G.selPayment="",G.selBizAdmin="",G.selSibLocks="",G.selCleanDB="",G.selimagesMod="",G.selStaticPages="",G.selLocations="",G.selsitemap="",G.selanswerimages=""}function q(){n.go("content")}function j(){console.log("apply Rule")}var G=this;G.title="admin",G.selKeywords="active",G.selViews="",G.selFlags="",G.selRankings="",G.selPlan="",G.selCleanDB="",G.goBack=q,G.keywords=A,G.views=S,G.flags=R,G.addRank=E,G.dbMaint=P,G.dbQuery=C,G.update=O,G.foodranks=I,G.sibLocs=x,G.payment=$,G.plan=D,G.bizAdmin=T,G.applyRule=j,G.cleanDB=M,G.modImages=_,G.staticPages=L,G.golocations=N,G.gositemap=U,G.goanswerimages=F,G.dataready=!1,function(){e.isAdmin||e.dataAdmin||e.modAdmin?(G.isDET=e.isLoggedIn&&("10104518570729893"==e.user.id||30==e.user.id||41==e.user.id||42==e.user.id||30==e.user.id||0xaaf2b1002387==e.user.id||0xb07a74be061a==e.user.id),G.isAdmin=e.user.is_sys_admin||e.isAdmin,G.dataAdmin=e.dataAdmin,G.modAdmin=e.modAdmin,b(),e.DEBUG_MODE&&console.log("admin page Loaded!")):n.go("cwrapper")}()}angular.module("app").controller("admin",e),e.$inject=["$rootScope","$state","table","answer","categories","table2","categorycode","$q","vrows","catans","common","dataloader","locations","special","matchrec","useractivity","edit","useraccnt","staticpages","$timeout","votes"]}(),function(){"use strict";function e(e,n,t,a,s,o){function i(){d.title=l.rankTitle,d.tags=l.tags,d.keywords=l.keywords,d.type=l.type,d.question=l.question,d.views=0,d.answers=0,(null==d.title||void 0==d.title||d.title.length<10)&&(u=!1),(null==d.question||void 0==d.question||d.question.length<10)&&(f=!1),"Person"!=d.type&&"Establishment"!=d.type&&"Short-Phrase"!=d.type&&"Event"!=d.type&&"Organization"!=d.type&&"Place"!=d.type&&"Activity"!=d.type&&"Thing"!=d.type&&"PersonCust"!=d.type&&(g=!1)}function r(){if(i(),console.log("vm.allNh --- ",l.allNh),0==l.allNh||void 0==l.allNh)u&&g&&f?(s.addTable(d),c()):u?f?o.getDialog("rankType"):o.getDialog("rankQuestion"):o.getDialog("rankTitle");else if(u&&g&&f){for(var e=0;e<n.content.length;e++)if(n.content[e].title.indexOf("Yoga studios in")>-1){var t=JSON.parse(JSON.stringify(n.content[e]));t.id=void 0;var a=t.title.replace("Yoga studios in",l.rankTitle);t.title=a;var r=l.tags;t.tags=r,a.indexOf("Pacific Beach")>-1&&(t.tags=t.tags+" pb"),a.indexOf("Ocean Beach")>-1&&(t.tags=t.tags+" ob"),a.indexOf("Mission Beach")>-1&&(t.tags=t.tags+" mb"),a.indexOf("in San Diego")>-1&&(t.tags=t.tags+" isMP",t.isatomic=!1),a.indexOf("in Downtown")>-1&&(t.isatomic=!1),t.answers=0,t.views=0,t.answertags="",t.catstr="",s.addTable(t)}c()}else u?f?o.getDialog("rankType"):o.getDialog("rankQuestion"):o.getDialog("rankTitle")}function c(){d={},l.rankTitle="",l.tags="",l.keywords="",l.type="",l.isatomic=!0,l.question="",l.image1url="",l.image2url="",l.image3url=""}var l=this;l.title="addRank";var d={},u=!0,g=!0,f=!0;l.addRanking=r,l.typeList=["Person","Establishment","Place","Activity","Short-Phrase","Organization","Event","Thing","PersonCust"],l.isAdmin=n.isAdmin,function(){console.log("addRank page Loaded!")}()}angular.module("app").controller("addRank",e),e.$inject=["$location","$rootScope","$state","$stateParams","table","dialog"]}();